<!DOCTYPE html>
<html lang="ru">
<head>
        <script>
            // РљРѕРЅС„РёРіСѓСЂР°С†РёСЏ РїРѕРґРєР»СЋС‡РµРЅРёСЏ Рє API
            window.CYBER_VIS_API_BASE = 'https://api.cybattack.ru';
            window.CYBER_VIS_WS_URL = 'wss://api.cybattack.ru/ws/monitor';
        </script>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cyber-Vis Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            min-height: 100vh;
            padding: 20px;
        }
        .container { max-width: 1400px; margin: 0 auto; }
        .header { text-align: center; margin-bottom: 30px; }
        .stats-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px; 
            margin-bottom: 30px;
        }
        .stat-card { 
            background: rgba(255, 255, 255, 0.1); 
            padding: 20px; 
            border-radius: 10px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .stat-value { 
            font-size: 2em; 
            font-weight: bold; 
            margin: 10px 0;
            color: #4cc9f0;
        }
        .chart-container { 
            background: rgba(255, 255, 255, 0.1); 
            padding: 20px; 
            border-radius: 10px;
            margin-bottom: 20px;
            height: 400px;
        }
        .event-log {
            background: rgba(0, 0, 0, 0.3);
            padding: 20px;
            border-radius: 10px;
            max-height: 300px;
            overflow-y: auto;
        }
        .event { 
            padding: 10px; 
            margin-bottom: 5px; 
            background: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
        }
        .event.success { border-left: 4px solid #4ade80; }
        .event.error { border-left: 4px solid #f87171; }
        .event.warning { border-left: 4px solid #fbbf24; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>рџљЂ Cyber-Vis РњРѕРЅРёС‚РѕСЂРёРЅРі РІ СЂРµР°Р»СЊРЅРѕРј РІСЂРµРјРµРЅРё</h1>
            <p>Р’СЃРµ РїРѕРґРєР»СЋС‡РµРЅРёСЏ Рё РїРѕРїС‹С‚РєРё РІС…РѕРґР° РѕС‚РѕР±СЂР°Р¶Р°СЋС‚СЃСЏ Р·РґРµСЃСЊ</p>
            <div class="status">
                <span id="wsStatus">рџ”ґ РќРµ РїРѕРґРєР»СЋС‡РµРЅРѕ</span>
            </div>
        </div>

        <div class="stats-grid" id="statsGrid">
            <!-- РЎС‚Р°С‚РёСЃС‚РёРєР° Р±СѓРґРµС‚ Р·Р°РїРѕР»РЅРµРЅР° JavaScript -->
        </div>

        <div class="chart-container">
            <canvas id="loginChart"></canvas>
        </div>

        <div class="chart-container">
            <canvas id="activityChart"></canvas>
        </div>

        <h2>рџ“‹ РџРѕСЃР»РµРґРЅРёРµ СЃРѕР±С‹С‚РёСЏ</h2>
        <div class="event-log" id="eventLog">
            <!-- РЎРѕР±С‹С‚РёСЏ Р±СѓРґСѓС‚ РґРѕР±Р°РІР»СЏС‚СЊСЃСЏ Р·РґРµСЃСЊ -->
        </div>
    </div>

    <script>
        // WebSocket РїРѕРґРєР»СЋС‡РµРЅРёРµ
        let ws = null;
        let loginChart = null;
        let activityChart = null;

    const API_BASE = (typeof CYBER_VIS_API_BASE !== 'undefined') ? CYBER_VIS_API_BASE : (location.protocol + '//' + location.host);
    const WS_URL = (typeof CYBER_VIS_WS_URL !== 'undefined') ? CYBER_VIS_WS_URL : ((location.protocol === 'https:') ? 'wss://' + location.host + '/ws/monitor' : 'ws://' + location.host + '/ws/monitor');
    console.log('🚀 Страница загружена');
    console.log('API_BASE:', API_BASE);
    console.log('WS_URL:', WS_URL);
// РџРѕРґРєР»СЋС‡РµРЅРёРµ Рє WebSocket
        function connectWebSocket() {
            ws = new WebSocket(WS_URL);
            
            ws.onopen = () => {
                document.getElementById('wsStatus').innerHTML = 'рџџў РџРѕРґРєР»СЋС‡РµРЅРѕ';
                console.log('вњ… РџРѕРґРєР»СЋС‡РµРЅРѕ Рє WebSocket');
            };
            
            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                handleWebSocketMessage(data);
            };
            
            ws.onerror = (error) => {
                console.error('WebSocket РѕС€РёР±РєР°:', error);
                document.getElementById('wsStatus').innerHTML = 'рџ”ґ РћС€РёР±РєР° РїРѕРґРєР»СЋС‡РµРЅРёСЏ';
            };
            
            ws.onclose = () => {
                document.getElementById('wsStatus').innerHTML = 'рџ”ґ РћС‚РєР»СЋС‡РµРЅРѕ';
                console.log('WebSocket Р·Р°РєСЂС‹С‚, РїРµСЂРµРїРѕРґРєР»СЋС‡РµРЅРёРµ С‡РµСЂРµР· 5 СЃРµРєСѓРЅРґ...');
                setTimeout(connectWebSocket, 5000);
            };
        }
        
        // РћР±СЂР°Р±РѕС‚РєР° СЃРѕРѕР±С‰РµРЅРёР№ WebSocket
        function handleWebSocketMessage(data) {
            switch(data.type) {
                case 'init':
                    updateStats(data.data.stats);
                    updateCharts(data.data);
                    addEvent('вњ… РРЅРёС†РёР°Р»РёР·Р°С†РёСЏ РґР°РЅРЅС‹С…', 'success');
                    break;
                    
                case 'login_success':
                    addEvent(`вњ… РџРѕР»СЊР·РѕРІР°С‚РµР»СЊ ${data.data.username} РІРѕС€РµР» РІ СЃРёСЃС‚РµРјСѓ`, 'success');
                    updateStatsAfterEvent('successful_logins');
                    break;
                    
                case 'login_failed':
                    addEvent(`вќЊ РќРµСѓРґР°С‡РЅР°СЏ РїРѕРїС‹С‚РєР° РІС…РѕРґР°: ${data.data.username}`, 'error');
                    updateStatsAfterEvent('failed_logins');
                    break;
                    
                case 'stats_update':
                    updateStats(data.data);
                    break;
                    
                case 'metric_update':
                    updateMetricChart(data.data);
                    break;
                    
                case 'client_disconnected':
                    addEvent(`рџ‘‹ РљР»РёРµРЅС‚ РѕС‚РєР»СЋС‡РёР»СЃСЏ`, 'warning');
                    break;
            }
        }
        
        // РћР±РЅРѕРІР»РµРЅРёРµ СЃС‚Р°С‚РёСЃС‚РёРєРё
        function updateStats(stats) {
            const statsGrid = document.getElementById('statsGrid');
            
            const statsData = [
                { label: 'РђРєС‚РёРІРЅС‹Рµ СЃРµСЃСЃРёРё', value: stats.active_sessions || 0, icon: 'рџ‘Ґ' },
                { label: 'РЈСЃРїРµС€РЅС‹С… РІС…РѕРґРѕРІ', value: stats.login_attempts?.successful || 0, icon: 'вњ…' },
                { label: 'РќРµСѓРґР°С‡РЅС‹С… РїРѕРїС‹С‚РѕРє', value: stats.login_attempts?.failed || 0, icon: 'вќЊ' },
                { label: 'Р’СЃРµРіРѕ РїРѕРїС‹С‚РѕРє', value: stats.login_attempts?.total || 0, icon: 'рџ“Љ' },
                { label: 'РЈРЅРёРєР°Р»СЊРЅС‹С… РїРѕР»СЊР·РѕРІР°С‚РµР»РµР№', value: stats.unique_users || 0, icon: 'рџ‘¤' },
                { label: 'Р—Р° 24 С‡Р°СЃР°', value: stats.last_24h?.total || 0, icon: 'рџ•ђ' }
            ];
            
            statsGrid.innerHTML = statsData.map(stat => `
                <div class="stat-card">
                    <div class="stat-icon">${stat.icon}</div>
                    <div class="stat-label">${stat.label}</div>
                    <div class="stat-value">${stat.value}</div>
                </div>
            `).join('');
        }
        
        function updateStatsAfterEvent(type) {
            // Р—РґРµСЃСЊ РјРѕР¶РЅРѕ РґРѕР±Р°РІРёС‚СЊ Р»РѕРіРёРєСѓ РґР»СЏ РёРЅРєСЂРµРјРµРЅС‚Р° СЃС‚Р°С‚РёСЃС‚РёРєРё
            console.log(`РЎС‚Р°С‚РёСЃС‚РёРєР° РѕР±РЅРѕРІР»РµРЅР°: ${type}`);
        }
        
        // Р”РѕР±Р°РІР»РµРЅРёРµ СЃРѕР±С‹С‚РёСЏ РІ Р»РѕРі
        function addEvent(message, type = 'info') {
            const eventLog = document.getElementById('eventLog');
            const eventDiv = document.createElement('div');
            eventDiv.className = `event ${type}`;
            eventDiv.innerHTML = `
                <span style="color: #aaa">[${new Date().toLocaleTimeString()}]</span>
                ${message}
            `;
            eventLog.prepend(eventDiv);
            
            // РћРіСЂР°РЅРёС‡РёРІР°РµРј РєРѕР»РёС‡РµСЃС‚РІРѕ СЃРѕР±С‹С‚РёР№
            while (eventLog.children.length > 50) {
                eventLog.removeChild(eventLog.lastChild);
            }
        }
        
        // РРЅРёС†РёР°Р»РёР·Р°С†РёСЏ РіСЂР°С„РёРєРѕРІ
        function initCharts() {
            const loginCtx = document.getElementById('loginChart').getContext('2d');
            loginChart = new Chart(loginCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'РџРѕРїС‹С‚РєРё РІС…РѕРґР° РІ С‡Р°СЃ',
                        data: [],
                        borderColor: 'rgb(75, 192, 192)',
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'РђРєС‚РёРІРЅРѕСЃС‚СЊ РІС…РѕРґР° РїРѕ РІСЂРµРјРµРЅРё'
                        }
                    }
                }
            });
            
            const activityCtx = document.getElementById('activityChart').getContext('2d');
            activityChart = new Chart(activityCtx, {
                type: 'doughnut',
                data: {
                    labels: ['РЈСЃРїРµС€РЅС‹Рµ', 'РќРµСѓРґР°С‡РЅС‹Рµ'],
                    datasets: [{
                        data: [0, 0],
                        backgroundColor: [
                            'rgba(75, 192, 192, 0.8)',
                            'rgba(255, 99, 132, 0.8)'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'РЎРѕРѕС‚РЅРѕС€РµРЅРёРµ РїРѕРїС‹С‚РѕРє РІС…РѕРґР°'
                        }
                    }
                }
            });
        }
        
        function updateCharts(data) {
            if (loginChart && activityChart) {
                // РћР±РЅРѕРІР»СЏРµРј РіСЂР°С„РёРєРё РЅР° РѕСЃРЅРѕРІРµ РїРѕР»СѓС‡РµРЅРЅС‹С… РґР°РЅРЅС‹С…
                const success = data.stats?.login_attempts?.successful || 0;
                const failed = data.stats?.login_attempts?.failed || 0;
                
                activityChart.data.datasets[0].data = [success, failed];
                activityChart.update();
            }
        }
        
        function updateMetricChart(metricData) {
            // Р—РґРµСЃСЊ РјРѕР¶РЅРѕ РґРѕР±Р°РІРёС‚СЊ РѕР±РЅРѕРІР»РµРЅРёРµ РіСЂР°С„РёРєРѕРІ РјРµС‚СЂРёРє
            console.log('РњРµС‚СЂРёРєР° РїРѕР»СѓС‡РµРЅР°:', metricData);
        }
        
        // РРЅРёС†РёР°Р»РёР·Р°С†РёСЏ РїСЂРё Р·Р°РіСЂСѓР·РєРµ СЃС‚СЂР°РЅРёС†С‹
        window.addEventListener('load', () => {
            initCharts();
            connectWebSocket();
            
            // РџРµСЂРёРѕРґРёС‡РµСЃРєРѕРµ РѕР±РЅРѕРІР»РµРЅРёРµ (fallback)
            setInterval(() => {
                if (ws && ws.readyState === WebSocket.OPEN) {
                    ws.send(JSON.stringify({ type: 'ping' }));
                }
            }, 30000);
        });
    </script>
</body>
</html>
